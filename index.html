<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>QRnok</title>
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#ffffff"/>
<style>
:root{--bg:#fff;--fg:#111;--muted:#666;--primary:#d32f2f;--ok:#2e7d32;--nok:#c62828;--shadow:rgba(0,0,0,.08)}
*{box-sizing:border-box}html,body{height:100%;margin:0}body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;user-select:none;display:flex;flex-direction:column}
header{padding:10px 16px 6px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:center;position:sticky;top:0;background:var(--bg);z-index:10}
.logo{display:flex;align-items:center;gap:10px;font-weight:800;font-size:22px;letter-spacing:.4px}
.logo .brand{color:var(--primary)}.miniqr{width:22px;height:22px;display:inline-block}
.content{flex:1;display:flex;flex-direction:column;padding:10px 12px 0;gap:10px}
.refbar{display:flex;gap:8px;align-items:center;justify-content:center}
.refbar input{flex:1;max-width:420px;border:1px solid #ddd;padding:10px 12px;border-radius:12px;font-size:16px;background:#fafafa}
.refbar button{border:1px solid #ddd;background:#f7f7f7;padding:10px 12px;border-radius:12px}
.camera{position:relative;margin:0 auto;width:min(96vw,520px);aspect-ratio:3/4;border-radius:16px;overflow:hidden;box-shadow:0 6px 24px var(--shadow);background:#000}
#reader{width:100%;height:100%}.frame{position:absolute;inset:0;pointer-events:none;border:4px solid rgba(0,0,0,0);border-radius:16px;transition:border-color .15s}
.frame.ok{border-color:var(--ok)}.frame.nok{border-color:var(--nok)}
.status{text-align:center;min-height:1.4em;font-weight:600;color:var(--muted)}
.bottombar{border-top:1px solid #eee;background:var(--bg);display:flex;justify-content:space-around;padding:6px 4px env(safe-area-inset-bottom);position:sticky;bottom:0}
.navbtn{display:flex;flex-direction:column;align-items:center;gap:2px;min-width:72px;padding:6px 8px;border-radius:10px;text-decoration:none;color:inherit}
.navbtn:active{background:#f3f3f3}.navbtn svg{width:24px;height:24px}.navbtn .label{font-size:12px;color:#222}
dialog::backdrop{background:rgba(0,0,0,.3)}dialog{border:none;border-radius:16px;padding:0;width:min(92vw,640px);box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
.modal-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #eee;background:#fff}.modal-head h3{margin:0;font-size:16px}
.modal-body{padding:12px 14px;background:#fff;max-height:70vh;overflow:auto}table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid #f0f0f0;font-size:14px;text-align:left}th{position:sticky;top:0;background:#fff}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}.pill.ok{background:#e8f5e9;color:var(--ok)}.pill.nok{background:#ffebee;color:var(--nok)}.muted{color:#777}
</style>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
<header>
  <div class="logo" aria-label="QRnok">
    <span class="brand">QRnok</span>
    <svg class="miniqr" viewBox="0 0 24 24" aria-hidden="true">
      <rect x="2" y="2" width="8" height="8" fill="#d32f2f" rx="1"/><rect x="4" y="4" width="4" height="4" fill="#fff" rx="1"/>
      <rect x="14" y="2" width="8" height="8" fill="#d32f2f" rx="1"/><rect x="16" y="4" width="4" height="4" fill="#fff" rx="1"/>
      <rect x="2" y="14" width="8" height="8" fill="#d32f2f" rx="1"/><rect x="4" y="16" width="4" height="4" fill="#fff" rx="1"/>
    </svg>
  </div>
</header>
<main class="content">
  <div class="refbar">
    <input id="refInput" type="text" placeholder="Wzorzec — wpisz ręcznie lub ustaw skanem" inputmode="text" autocomplete="off"/>
    <button id="setRefBtn" title="Ustaw wzorzec z wpisu">Ustaw</button>
    <button id="scanRefBtn" title="Ustaw wzorzec skanem">Skan wzorca</button>
  </div>
  <section class="camera">
    <div id="reader"></div>
    <div id="frame" class="frame"></div>
  </section>
  <div id="status" class="status">Gotowe do skanowania…</div>
</main>
<nav class="bottombar" aria-label="Nawigacja">
  <a class="navbtn" id="btnScan" href="javascript:void(0)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 7V5a1 1 0 0 1 1-1h2M17 4h2a1 1 0 0 1 1 1v2M20 17v2a1 1 0 0 1-1 1h-2M7 20H5a1 1 0 0 1-1-1v-2" stroke-width="2" stroke-linecap="round"/></svg>
    <span class="label">Skanuj</span>
  </a>
  <a class="navbtn" id="btnRef" href="javascript:void(0)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 4h16v6H4zM4 14h10v6H4zM18 14h2v6h-2z" stroke-width="2" stroke-linejoin="round"/></svg>
    <span class="label">Wzorzec</span>
  </a>
  <a class="navbtn" id="btnHistory" href="javascript:void(0)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 8v5l3 3M3 3v5h5" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="13" r="8" stroke-width="2"/></svg>
    <span class="label">Historia</span>
  </a>
  <a class="navbtn" id="btnSettings" href="javascript:void(0)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke-width="2"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 3.21 19.4l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H2a2 2 0 1 1 0-4h.09c.66 0 1.26-.38 1.54-.97Z" stroke-width="1.7"/></svg>
    <span class="label">Ustawienia</span>
  </a>
</nav>

<dialog id="historyModal" aria-labelledby="hTitle">
  <div class="modal-head">
    <h3 id="hTitle">Historia</h3>
    <button id="clearHistoryBtn" style="border:1px solid #eee;background:#fff;padding:8px 10px;border-radius:10px">Wyczyść</button>
  </div>
  <div class="modal-body">
    <table>
      <thead><tr><th>Data i czas</th><th>Wzorzec</th><th>Odczyt</th><th>Wynik</th></tr></thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>
</dialog>

<dialog id="settingsModal" aria-labelledby="sTitle">
  <div class="modal-head">
    <h3 id="sTitle">Ustawienia</h3>
    <span></span>
  </div>
  <div class="modal-body">
    <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
      <input type="checkbox" id="soundToggle" checked/> Dźwięk (OK/NOK)
    </label>
    <button id="resetAllBtn" style="border:1px solid #eee;background:#fff;padding:10px 12px;border-radius:10px">Reset danych</button>
    <p class="muted" style="margin-top:8px;">Dane (wzorzec, historia) są zapisywane tylko lokalnie w przeglądarce.</p>
  </div>
</dialog>

<script>
if (screen.orientation && screen.orientation.lock) { screen.orientation.lock('portrait').catch(()=>{}); }

let soundOn = true;
function beep(duration=150, frequency=1000, volume=0.9){
  if(!soundOn) return;
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type='sine'; osc.frequency.value=frequency; gain.gain.value=volume;
    osc.start(); setTimeout(()=>{ try{osc.stop();ctx.close();}catch(e){} }, duration);
  }catch(e){}
}
function okBeep(){ beep(150, 1000, 0.9); }
function nokBeep(){ beep(1500, 300, 0.9); }

const frame = document.getElementById('frame');
function flashOK(){ frame.classList.remove('nok'); frame.classList.add('ok'); setTimeout(()=>frame.classList.remove('ok'), 220); }
function flashNOK(){ frame.classList.remove('ok'); frame.classList.add('nok'); setTimeout(()=>frame.classList.remove('nok'), 1600); }

const REF_KEY='qrnok_ref_v1', HISTORY_KEY='qrnok_hist_v1';
const refInput=document.getElementById('refInput');
const setRefBtn=document.getElementById('setRefBtn');
const scanRefBtn=document.getElementById('scanRefBtn');
const statusEl=document.getElementById('status');
const historyModal=document.getElementById('historyModal');
const settingsModal=document.getElementById('settingsModal');
const historyBody=document.getElementById('historyBody');
const clearHistoryBtn=document.getElementById('clearHistoryBtn');
const soundToggle=document.getElementById('soundToggle');

function getRef(){ return localStorage.getItem(REF_KEY) || ''; }
function setRef(v){ if(v){ localStorage.setItem(REF_KEY, v); refInput.value = v; } }
function clearRef(){ localStorage.removeItem(REF_KEY); refInput.value=''; }
function loadHistory(){ try{return JSON.parse(localStorage.getItem(HISTORY_KEY))||[]}catch(_){return[]} }
function saveHistory(h){ localStorage.setItem(HISTORY_KEY, JSON.stringify(h.slice(-500))); }
function pushHistory(entry){ const h=loadHistory(); h.push(entry); saveHistory(h); }

function renderHistory(){
  historyBody.innerHTML='';
  const rows=loadHistory().slice().reverse();
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.time}</td><td>${escapeHtml(r.ref)}</td><td>${escapeHtml(r.decoded)}</td><td>${r.match?'<span class="pill ok">OK</span>':'<span class="pill nok">NOK</span>'}</td>`;
    historyBody.appendChild(tr);
  }
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

let html5QrCode=null, settingRefMode=false, scanning=false;

async function startScan(){
  try{
    if(!html5QrCode) html5QrCode = new Html5Qrcode('reader');
    const devices = await Html5Qrcode.getCameras();
    if(!devices || !devices.length) throw new Error('Nie znaleziono kamery');
    const back = devices.find(d=>/back|rear|tył/i.test(d.label)) || devices[0];
    await html5QrCode.start(back.id, { fps: 10, qrbox: {width:240, height:240} }, onScan);
    scanning = true; statusEl.textContent = 'Skanowanie aktywne';
  }catch(e){ statusEl.textContent='Błąd kamery: '+e; }
}
async function stopScan(){ try{ if(html5QrCode && scanning) await html5QrCode.stop(); }catch(_){}
  scanning=false; statusEl.textContent='Skanowanie zatrzymane'; }

function onScan(decodedText){
  if(settingRefMode){
    setRef(decodedText); statusEl.textContent='Ustawiono wzorzec: '+decodedText; flashOK(); okBeep(); settingRefMode=false; return;
  }
  const ref = getRef() || refInput.value.trim();
  if(!ref){ statusEl.textContent='Ustaw wzorzec (wpisz lub skanuj).'; frame.classList.remove('ok','nok'); return; }
  const match = decodedText === ref;
  const now = new Date().toLocaleString();
  pushHistory({ time: now, ref, decoded: decodedText, match });
  if(match){ statusEl.textContent='✅ Zgodny: '+decodedText; flashOK(); okBeep(); }
  else { statusEl.textContent='❌ Niezgodny: '+decodedText; flashNOK(); nokBeep(); }
}

document.getElementById('btnScan').addEventListener('click', ()=>startScan());
document.getElementById('btnRef').addEventListener('click', ()=>{ settingRefMode = true; statusEl.textContent='Tryb ustawiania wzorca – zeskanuj kod referencyjny…'; frame.classList.remove('ok','nok'); });
document.getElementById('btnHistory').addEventListener('click', ()=>{ renderHistory(); historyModal.showModal(); });
document.getElementById('btnSettings').addEventListener('click', ()=>{ settingsModal.showModal(); });

setRefBtn.addEventListener('click', ()=>{ const v=refInput.value.trim(); if(!v){ alert('Wpisz wartość wzorca.'); return; } setRef(v); flashOK(); okBeep(); statusEl.textContent='Ustawiono wzorzec: '+v; });
scanRefBtn.addEventListener('click', ()=>{ settingRefMode=true; statusEl.textContent='Tryb ustawiania wzorca – zeskanuj kod referencyjny…'; });

clearHistoryBtn.addEventListener('click', ()=>{ if(confirm('Wyczyścić historię?')){ localStorage.removeItem(HISTORY_KEY); renderHistory(); } });
soundToggle.addEventListener('change', ()=>{ soundOn = soundToggle.checked; });

window.addEventListener('load', async ()=>{
  refInput.value = getRef();
  soundOn = true; soundToggle.checked = true;
  await startScan();
  if('serviceWorker' in navigator){ try{ await navigator.serviceWorker.register('sw.js'); }catch(e){} }
});
</script>
</body></html>
